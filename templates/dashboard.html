
{% extends "base.html" %}
{% block cards%}
<div class="container content-row">
    <div class="card-deck">
        <div class="card h-100 bg-light text-dark" style="width:200px">
            <div class="embed-responsive embed-responsive-16by9">
                <img class="card-img-top embed-responsive-item" src="{{ url_for('static', filename='img/twitter_logo.png') }}" alt="Card image">
            </div>
            <div class="card-body">
                <h4 class="card-title">{{ tweet_count }}</h4>
                <p class="card-text">Tweets loaded</p>
            </div>
        </div>

        <div class="card h-100 bg-light text-dark" style="width:200px">
            <div class="embed-responsive embed-responsive-16by9">
                <img class="card-img-top embed-responsive-item" src="{{ url_for('static', filename='img/price_icon.jpg') }}" alt="Card image">
            </div>
            <div class="card-body">
                <h4 class="card-title">{{ price_count }}</h4>
                <p class="card-text">Days of price history</p>
            </div>
        </div>

        <div class="card h-100 bg-light text-dark" style="width:200px">
            <div class="embed-responsive embed-responsive-16by9">
                <img class="card-img-top embed-responsive-item" src="{{ url_for('static', filename='img/news.png') }}" alt="Card image">
            </div>
            <div class="card-body">
                <h4 class="card-title">{{ news_count }}</h4>
                <p class="card-text">News articles loaded</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block graph %}
    <button id="one-day" class="btn btn-info">24 HR</button>
    <button id="one-week" class="btn btn-info">ONE WEEK</button>
    <button id="one-month" class="btn btn-info">ONE MONTH</button>
    <button id="three-months" class="btn btn-info">THREE MONTHS</button>
    <button id="one-year" class="btn btn-info">1 YEAR</button>
    <button id="all" class="btn btn-info">ALL</button>
    <div class="row">
        <div class="col">
            <div id="synced-charts">
                <div id="btc_price"></div>
                <div id="tweet_sentiment"></div>
                <script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"> </script>
                <script>
                    let start_date = new Date('2020-03-21');
                  var optionsLine = {
                        series: [{
                            name: 'BTC Price (USD)',
                            data: [
                                {% for daily_price in prices %}
                                    {
                                        x: new Date('{{ daily_price.date }}').getTime(),
                                        y: {{ daily_price.average }}
                                    },
                                {% endfor %}
                            ]
                        }],
                        colors: ['#00E396'],
                        chart: {
                            id: 'btc_price_column',
                            group: 'social',
                            type: 'area',
                            height: 400,
                            foreColor: '#53eeee'
                        },
                        dataLabels: {
                            enabled: false
                        },
                        yaxis: {
                            labels: {
                                minWidth: 40
                            }
                        },
                        xaxis: {
                            type: 'datetime',
                            min: start_date.getTime(),
                        }
                    };
                    var chart = new ApexCharts(document.querySelector("#btc_price"), optionsLine)
                    chart.render()

                    var optionsArea = {
                        series: [{
                            name: 'Average Tweet Sentiment',
                            data: [
                                {% for sentiment in tweet_sentiments %}
                                    {
                                        x: new Date('{{ sentiment.date }}').getTime(),
                                        y: {{ sentiment.avg_sentiment }}
                                    },
                                {% endfor %}
                            ]
                        },
                        {
                            name: 'Average News Sentiment',
                            data: [
                                {% for sentiment in article_sentiments %}
                                    {
                                        x: new Date('{{ sentiment.date }}').getTime(),
                                        y: {{ sentiment.avg_sentiment }}
                                    },
                                {% endfor %}
                            ]
                        }],
                        colors: ['#008FFB', '#ff4848'],
                        chart: {
                            id: 'tweet_sentiment_line',
                            group: 'social',
                            type: 'line',
                            height: 400,
                            foreColor: '#53eeee'
                        },
                        yaxis: {
                            labels: {
                                minWidth: 40
                            }
                        },
                        xaxis: {
                            type: 'datetime',
                            min: start_date.getTime(),
                        }
                    };
                    var chart2 = new ApexCharts(document.querySelector("#tweet_sentiment"), optionsArea)
                    chart2.render()

                    let resetCssClasses = function(activeEl) {
                        let els = document.querySelectorAll('button');
                        Array.prototype.forEach.call(els, function(el) {
                            el.classList.remove('active');
                        });
                        activeEl.target.classList.add('active');
                    }

                    function zoom(days) {
                        let date = new Date();
                        date.setHours(0,0,0,0);
                        let start = new Date(date.getTime() - (days * 24 * 60 * 60 * 1000));
                        chart.zoomX(
                            start.getTime(),
                            date.getTime()
                        );
                        chart2.zoomX(
                            start.getTime(),
                            date.getTime()
                        );
                        let news_iframe = $('#articles');
                        let tweets_iframe = $('#tweets');

                        let news_url = "{{ url_for('btc_news') }}?since=" + start.toISOString().split('T')[0];
                        let tweets_url = "{{ url_for('btc_dashboard_tweets') }}?since=" + start.toISOString().split('T')[0];

                        news_iframe.attr('src', news_url);
                        tweets_iframe.attr('src', tweets_url);
                    }

                    document.querySelector('#one-day').addEventListener('click', function(e) {
                        resetCssClasses(e);
                        zoom(1);
                    });

                    document.querySelector('#one-week').addEventListener('click', function(e) {
                        resetCssClasses(e);
                        zoom(7);
                    });

                    document.querySelector('#one-month').addEventListener('click', function(e) {
                        resetCssClasses(e);
                        zoom(30);
                    });

                    document.querySelector('#three-months').addEventListener('click', function(e) {
                        resetCssClasses(e);
                        zoom(90);
                    });

                    document.querySelector('#one-year').addEventListener('click', function(e) {
                        resetCssClasses(e);
                        zoom(365);
                    });

                    document.querySelector('#all').addEventListener('click', function(e) {
                        resetCssClasses(e);
                        let date = new Date();
                        chart.zoomX(
                            start_date.getTime(),
                            date.getTime()
                        );
                        chart2.zoomX(
                            start_date.getTime(),
                            date.getTime()
                        );
                        let news_iframe = $('#articles');
                        let tweets_iframe = $('#tweets');

                        let news_url = "{{ url_for('btc_news') }}";
                        let tweets_url = "{{ url_for('btc_dashboard_tweets') }}";

                        news_iframe.attr('src', news_url);
                        tweets_iframe.attr('src', tweets_url);
                    });
                </script>
            </div>
        </div>
    </div>
    {% endblock %}
    {% block news %}
    <div class="row">
            <div class="col">
                <iframe src="{{ url_for('btc_dashboard_tweets') }}" id="tweets" name="tweets" onload='javascript:(function(o){o.style.height=o.contentWindow.document.body.scrollHeight+"px";}(this));' style="height:800px;width:100%;border:none;overflow:hidden;"></iframe>
            </div>
            <div class="col">
                <iframe src="{{ url_for('btc_news') }}" id="articles" name="articles" onload='javascript:(function(o){o.style.height=o.contentWindow.document.body.scrollHeight+"px";}(this));' style="height:auto;width:100%;border:none;overflow:hidden;"></iframe>
            </div>
        </div>
  {% endblock %}

  {% block wordcloud %}
        <div class="row">
          <div class="col">
            <meta charset="utf-8">
            <!-- Load d3.js -->
            <script src="https://d3js.org/d3.v4.js"></script>
            <!-- Load d3-cloud -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.js"></script>

            <svg id="wordcloud" width=1600 height=960>
            <!-- svg-section is where we generate our word cloud -->
            </svg>

            <script>
            var fill = d3.scaleOrdinal(d3.schemeCategory20);

            var data = [{text: "money", value: 3991}, {text: "bitcoin", value: 3624}, {text: "gift", value: 3281}, {text: "wrapped", value: 3253}, {text: "price", value: 3141}, {text: "bag", value: 2796}, {text: "rocket", value: 2452}, {text: "btc", value: 1845}, {text: "face", value: 1816}, {text: "buy", value: 1718}, {text: "get", value: 1628}, {text: "market", value: 1615}, {text: "link", value: 1544}, {text: "crypto", value: 1492}, {text: "value", value: 1465}, {text: "live", value: 1362}, {text: "airdrop", value: 1303}, {text: "click", value: 1251}, {text: "time", value: 1240}, {text: "referral", value: 1227}, {text: "rewards", value: 1204}, {text: "amp", value: 1203}, {text: "amazing", value: 1174}, {text: "trophy", value: 1127}, {text: "like", value: 1119}, {text: "new", value: 1100}, {text: "usd", value: 1096}, {text: "participate", value: 1088}, {text: "last", value: 1077}, {text: "silhouette", value: 1067}, {text: "busts", value: 1064}, {text: "confused", value: 1042}, {text: "via", value: 1011}, {text: "right", value: 973}, {text: "one", value: 960}, {text: "chart", value: 934}, {text: "free", value: 922}, {text: "fire", value: 880}, {text: "index", value: 840}, {text: "current", value: 798}, {text: "pointing", value: 786}, {text: "backhand", value: 761}, {text: "see", value: 758}, {text: "trading", value: 750}, {text: "people", value: 736}, {text: "long", value: 708}, {text: "next", value: 704}, {text: "today", value: 693}, {text: "high", value: 692}, {text: "us", value: 691}, {text: "going", value: 667}, {text: "join", value: 657}, {text: "good", value: 654}, {text: "check", value: 653}, {text: "go", value: 639}, {text: "would", value: 611}, {text: "worth", value: 607}, {text: "eyes", value: 598}, {text: "smiling", value: 591}, {text: "still", value: 589}, {text: "drunk", value: 576}, {text: "day", value: 568}, {text: "top", value: 559}, {text: "hand", value: 553}, {text: "think", value: 551}, {text: "earn", value: 541}, {text: "person", value: 537}, {text: "short", value: 526}, {text: "bet", value: 526}, {text: "back", value: 525}, {text: "sell", value: 524}, {text: "first", value: 519}, {text: "volume", value: 516}, {text: "trade", value: 506}, {text: "make", value: 505}, {text: "exchange", value: 500}, {text: "world", value: 496}, {text: "blockchain", value: 489}, {text: "use", value: 479}, {text: "hour", value: 477}, {text: "binance", value: 474}, {text: "hours", value: 472}, {text: "gold", value: 469}, {text: "way", value: 469}, {text: "know", value: 468}, {text: "year", value: 466}, {text: "need", value: 463}, {text: "news", value: 457}, {text: "mark", value: 456}, {text: "days", value: 455}, {text: "arrow", value: 455}, {text: "big", value: 454}, {text: "update", value: 452}, {text: "could", value: 448}, {text: "raising", value: 447}, {text: "gt", value: 445}, {text: "white", value: 444}, {text: "sign", value: 440}, {text: "best", value: 440}, {text: "change", value: 438}];


            var layout = d3.layout.cloud()
                .size([1600, 960])
                .words(data)
                // .font("Impact")
                .padding(.5)

                .on("end", draw);

            layout.start();

            function draw(words) {
                d3.select("#wordcloud")
                    .append("g")
                    .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
                    .selectAll("text")
                    .data(words)
                    .enter()
                    .append("text")
                    .text((d) => d.text)
                    .style("font-size", (d) => d.size + "px")
                    .style("font-family", (d) => d.font)
                    .style("fill", (d, i) => fill(i))
                    .attr("text-anchor", "middle")
                    .attr("transform", (d) => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")")
            }
            </script>
          </div>
        </div>
{% endblock %}
